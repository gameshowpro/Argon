name: Build Core

on:
  workflow_call:
    inputs:
      ARGON_PACKAGE_NAME_BASE:
        required: true
        type: string
      ARGON_DOWNSTREAM_VERSION:
        required: true
        type: string
    secrets:
      ARGON_PRIVATE_KEY:
        required: true
      ARGON_PUBLIC_KEY:
        required: true
      ARGON_NOISE:
        required: true
      ARGON_TPM_AUTH:
        required: true
    outputs:
      release_tag:
        description: "The release tag created"
        value: ${{ jobs.build.outputs.release_tag }}

jobs:
  build:
    runs-on: windows-latest #required for Chocolatey packaging
    outputs:
      release_tag: ${{ steps.output_tag.outputs.release_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: gameshowpro/Argon
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Inject Secrets
        shell: pwsh
        env:
          ARGON_PRIVATE_KEY: ${{ secrets.ARGON_PRIVATE_KEY }}
          ARGON_PUBLIC_KEY: ${{ secrets.ARGON_PUBLIC_KEY }}
          ARGON_NOISE: ${{ secrets.ARGON_NOISE }}
          ARGON_TPM_AUTH: ${{ secrets.ARGON_TPM_AUTH }}
        run: ./scripts/injectSecrets.ps1

      - name: Configure Versioning
        id: version
        shell: pwsh
        run: |
          $jsonPath = "version.json"
          $versionJson = Get-Content $jsonPath | ConvertFrom-Json
          $majorMinor = $versionJson.version
          $downstream = "${{ inputs.ARGON_DOWNSTREAM_VERSION }}"
          
          if ($downstream -match "\.") {
              Write-Error "ARGON_DOWNSTREAM_VERSION ($downstream) cannot contain a dot (.)."
          }

          # Parse downstream version (e.g. "123-beta1" -> Patch=123, Suffix=-beta1)
          if ($downstream -match "^(\d+)(.*)$") {
              $patch = $matches[1]
              $suffix = $matches[2]
          } else {
              Write-Error "Invalid ARGON_DOWNSTREAM_VERSION format. Expected 'Patch[-Suffix]' (e.g. 123 or 123-beta1)"
          }

          $newVersion = "$majorMinor.$patch$suffix"
          
          # Update version.json so NBGV picks it up
          $versionJson.version = $newVersion
          $versionJson | ConvertTo-Json -Depth 10 | Set-Content $jsonPath
          
          Write-Host "Updated version.json to: $newVersion"


      - name: https://github.com/dotnet/nbgv
        id: nbgv
        uses: dotnet/nbgv@v0.4.2
        with:
          setAllVars: true

      - name: Pack NuGet (Argon.Common)
        run: |
          dotnet pack src/GameshowPro.Argon.Common/GameshowPro.Argon.Common.csproj -c Release -p:PackageId=${{ inputs.ARGON_PACKAGE_NAME_BASE }}.Argon.Common -o ./artifacts

      - name: Build and Pack Chocolatey
        shell: pwsh
        run: |
          $projects = @(
              @{ Name="Argon.Client"; Path="src/GameshowPro.Argon.Client/Argon.Client.csproj" },
              @{ Name="Argon.Service"; Path="src/GameshowPro.Argon.Service/Argon.Service.csproj" },
              @{ Name="Argon.Create"; Path="src/GameshowPro.Argon.Create/Argon.Create.csproj" },
              @{ Name="Argon.Test"; Path="src/GameshowPro.Argon.Test/Argon.Test.csproj" }
          )

          $chocoDir = "./build/choco"
          $baseName = "${{ inputs.ARGON_PACKAGE_NAME_BASE }}"
          $version = "${{ env.NBGV_SemVer2 }}"

          foreach ($proj in $projects) {
              # Publish
              dotnet publish $proj.Path -c Release -o "$chocoDir/$($proj.Name)/tools"

              # Pack
              $nuspec = Join-Path $chocoDir "$($proj.Name)\publish.nuspec"
              
              if (Test-Path $nuspec) {
                  Write-Host "Processing $nuspec for component $($proj.Name)"
                  
                  # Update ID and Version in nuspec
                  [xml]$xml = Get-Content $nuspec
                  $xml.package.metadata.id = "$baseName.$($proj.Name)"
                  $xml.package.metadata.version = $version
                  $xml.Save($nuspec)

                  choco pack $nuspec --output-directory ./artifacts
              } else {
                  Write-Warning "Nuspec file not found: $nuspec"
              }
          }

      - name: Build Linux Executable (Argon.Create)
        run: |
          dotnet publish src/GameshowPro.Argon.Create/Argon.Create.csproj -c Release -r linux-x64 --self-contained -o ./artifacts/linux
          $exeName = "${{ inputs.ARGON_PACKAGE_NAME_BASE }}.Argon.Create"
          Move-Item -Path "./artifacts/linux/Argon.Create" -Destination "./artifacts/linux/$exeName"
          
          # Create a tar.gz for easier distribution
          tar -czvf "./artifacts/$exeName-linux-x64.tar.gz" -C ./artifacts/linux .

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.NBGV_SemVer2 }}
          files: |
            ./artifacts/*.nupkg
            ./artifacts/*.tar.gz

      - name: Output Release Tag
        id: output_tag
        shell: pwsh
        run: echo "release_tag=v${{ env.NBGV_SemVer2 }}" >> $env:GITHUB_OUTPUT